---
layout: default
title: 活动日历
permalink: /cal/
---
<div class="container">
  <h2># 活动日历</h2>
  <div class="row">
    <span id="current"></span>
    <button class="button is-rounded" id="today">Today</button>
    <button class="button is-rounded" id="prev">Prev</button>
    <button class="button is-rounded" id="next">Next</button>
  </div>
  <div class="row">
    <div class="spacing"></div>
    <div id="calendar" style="width:100%; height:700px;"></div>
    <div class="spacing"></div>
  </div>
  <div id="subscribe-methods" class="col-md-12">
    <h3>订阅方式（不要使用上面日历中的链接）</h3>
    <p>iCal（请勿下载，直接使用地址）: <a
        href="https://www.google.com/calendar/ical/fphr1e519jsbi6dg2pll7kttt4%40group.calendar.google.com/public/basic.ics">https://www.google.com/calendar/ical/fphr1e519jsbi6dg2pll7kttt4%40group.calendar.google.com/public/basic.ics</a>
    </p>
    <p>Google 日历（点击右下角加号）: <a
        href="https://calendar.google.com/calendar/embed?src=fphr1e519jsbi6dg2pll7kttt4%40group.calendar.google.com&ctz=Asia%2FShanghai">https://calendar.google.com/calendar/embed?src=fphr1e519jsbi6dg2pll7kttt4%40group.calendar.google.com&ctz=Asia%2FShanghai</a>
    </p>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.css" />
<script src="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.js"></script>

<script>

  // TODO: maybe move to external js file and use a transpiler?

  const calendarUrl = '/cal.ics'; // TODO: replace with ics file on mirrors

  const container = document.getElementById('calendar');
  const options = {
    defaultView: 'month',
    usageStatistics: false,
    isReadOnly: true,
    week: {
      startDayOfWeek: 1,
    },
    gridSelection: false,
    timezone: {
      zones: [
        {
          timezoneName: 'Asia/Shanghai',
          displayLabel: 'Shanghai',
        }
      ],
    },
    useDetailPopup: true,
    // TODO: change the theme to adapt
  };

  const calendar = new tui.Calendar(container, options);

  const prevButton = $('button#prev')[0];
  const nextButton = $('button#next')[0];
  const todayButton = $('button#today')[0];
  const rangeText = $('span#current')[0];

  function updateMonth() {
    const rangeStart = calendar.getDateRangeStart();
    const rangeEnd = calendar.getDateRangeEnd();
    const middle = new Date((rangeStart.getTime() + rangeEnd.getTime()) / 2);
    rangeText.textContent = `${middle.getFullYear()} / ${middle.getMonth() + 1}`;
  }
  updateMonth();

  prevButton.addEventListener('click', function () {
    calendar.prev();
    updateMonth();
  });

  nextButton.addEventListener('click', function () {
    calendar.next();
    updateMonth();
  });

  todayButton.addEventListener('click', function () {
    calendar.today();
    updateMonth();
  });

  async function renderCalendar() {
    const resp = await fetch(calendarUrl, { mode: 'no-cors', redirect: 'follow' });
    const icalText = await resp.text();
    const cal = ICAL.parse(icalText);
    const comp = new ICAL.Component(cal);
    calendar.createEvents(comp.getAllSubcomponents("vevent").map(vevent => {
      var event = new ICAL.Event(vevent);
      return {
        id: event.uid,
        title: event.summary,
        start: event.startDate.toJSDate(),
        attendees: event.attendees,
        end: event.endDate.toJSDate(),
        location: event.location,
        body: event.description,
        category: 'time',
        raw: {
          class: 'calendar-item',
        },
        isReadOnly: true,
      };
    }));
  }

  document.addEventListener('DOMContentLoaded', renderCalendar);

</script>
